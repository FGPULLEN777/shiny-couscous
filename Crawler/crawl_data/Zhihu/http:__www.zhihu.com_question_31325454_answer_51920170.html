<!DOCTYPE html><html lang="zh-CN" dropEffect="none" class="no-js no-auth "><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="renderer" content="webkit" /><title>请问，多个线程可以读一个变量，只有一个线程可以对这个变量进行写，到底要不要加锁？ - 刘然的回答 - 知乎</title><meta name="apple-itunes-app" content="app-id=432274380, app-argument=zhihu://answers/51920170"><meta property="og:description" content="不是很同意 @北极 的答案，这个要分情况进行讨论，其实大多数时候并不需要加锁。第一种情况：读线程不会干扰写线程，换句话说，写变量的线程下面的操作不依赖于读线程已经看到自己所写的值时：不需要加锁，多核体系好比分布式系统，只有事件发生的因果顺序…" /><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta http-equiv="mobile-agent" content="format=html5;url=http://www.zhihu.com/question/31325454/answer/51920170"><meta id="znonce" name="znonce" content="cc68582f20444b2c82320554eabb847e"><link rel="apple-touch-icon-precomposed" href="http://static.zhihu.com/static/img/ios/zhihu(57px).png" /><link rel="apple-touch-icon-precomposed" href="http://static.zhihu.com/static/img/ios/zhihu(72px).png" sizes="72x72" /><link rel="apple-touch-icon-precomposed" href="http://static.zhihu.com/static/img/ios/zhihu(76px).png" sizes="76x76" /><link rel="apple-touch-icon-precomposed" href="http://static.zhihu.com/static/img/ios/zhihu(114px).png" sizes="114x114" /><link rel="apple-touch-icon-precomposed" href="http://static.zhihu.com/static/img/ios/zhihu(120px).png" sizes="120x120" /><link rel="apple-touch-icon-precomposed" href="http://static.zhihu.com/static/img/ios/zhihu(152px).png" sizes="152x152" /><link rel="shortcut icon" href="http://static.zhihu.com/static/favicon.ico" type="image/x-icon"><link rel="search" type="application/opensearchdescription+xml" href="http://static.zhihu.com/static/search.xml" title="知乎" /><link rel="stylesheet" href="http://static.zhihu.com/static/revved/-/css/z.e721bf59.css"><meta name="google-site-verification" content="FTeR0c8arOPKh8c5DYh_9uu98_zJbaWw53J-Sch9MTg" /><meta property="qc:admins" content="14414345146201056375" /><!--[if lt IE 9]><script src="http://static.zhihu.com/static/components/respond/dest/respond.min.js"></script><link href="http://static.zhihu.com/static/components/respond/cross-domain/respond-proxy.html" id="respond-proxy" rel="respond-proxy" /><link href="/static/components/respond/cross-domain/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" /><script src="/static/components/respond/cross-domain/respond.proxy.js"></script><![endif]--><script src="http://static.zhihu.com/static/revved/-/js/instant.4b42dd60.js"></script><link rel="canonical" href="http://www.zhihu.com/question/31325454" /></head><body class="zhi "><div role="navigation" class="zu-top"><div class="zg-wrap modal-shifting clearfix" id="zh-top-inner"><a href="/" class="zu-top-link-logo" id="zh-top-link-logo" data-za-c="view_home" data-za-a="visit_home" data-za-l="top_navigation_zhihu_logo">知乎</a><ul class="topnav-noauth clearfix"><li><a href="javascript:;" class="js-signup-noauth"><i class="zg-icon zg-icon-dd-home"></i>注册知乎</a></li><li><a href="javascript:;" class="js-signin-noauth">登录</a></li></ul><button class="zu-top-add-question" id="zu-top-add-question">提问</button><div role="search" id="zh-top-search" class="zu-top-search"><form method="GET" action="/search" id="zh-top-search-form" class="zu-top-search-form"><input type="hidden" name="type" value="question"><label for="q" class="hide-text">知乎搜索</label><input type="text" class="zu-top-search-input" id="q" name="q" autocomplete="off" value="" placeholder="搜索问题、话题或人"><button type="submit" class="zu-top-search-button"><span class="hide-text">搜索</span><span class="sprite-global-icon-magnifier-dark"></span></button></form></div><div id="zg-top-nav" class="zu-top-nav"><ul class="zu-top-nav-ul zg-clear"><li class="zu-top-nav-li " id="zh-top-nav-home"><a class="zu-top-nav-link" href="/" id="zh-top-link-home" data-za-c="view_home" data-za-a="visit_home" data-za-l="top_navigation_home">首页</a></li><li class="top-nav-topic-selector zu-top-nav-li " id="zh-top-nav-topic"><a class="zu-top-nav-link" href="/topic" id="top-nav-dd-topic">话题</a></li><li class="zu-top-nav-li " id="zh-top-nav-explore"><a class="zu-top-nav-link" href="/explore">发现</a></li></ul><div class="zu-top-nav-live zu-noti7-popup zg-r5px no-hovercard" id="zh-top-nav-live-new" role="popup" tabindex="0"><div class="zu-top-nav-live-inner zg-r5px"><div class="zu-top-live-icon">&nbsp;</div><div class="zu-home-noti-inner" id="zh-top-nav-live-new-inner"><div class="zm-noti7-popup-tab-container clearfix" tabindex="0"><button class="zm-noti7-popup-tab-item message"><span class="icon">消息</span></button><button class="zm-noti7-popup-tab-item user"><span class="icon">用户</span></button><button class="zm-noti7-popup-tab-item thanks"><span class="icon">赞同和感谢</span></button></div></div><div class="zm-noti7-frame-border top"></div><div class="zm-noti7-frame"><div class="zm-noti7-content"><div class="zm-noti7-content-inner"><div class="zm-noti7-content-body"><div class="zm-noti7-popup-loading"><span class="noti-spinner-loading"></span></div></div></div></div><div class="zm-noti7-content" style="display:none;"><div class="zm-noti7-content-inner"><div class="zm-noti7-content-body"><div class="zm-noti7-popup-loading"><span class="noti-spinner-loading"></span></div></div></div></div><div class="zm-noti7-content" style="display:none;"><div class="zm-noti7-content-inner"><div class="zm-noti7-content-body"><div class="zm-noti7-popup-loading"><span class="noti-spinner-loading"></span></div></div></div></div></div><div class="zm-noti7-frame-border bottom"></div><div class="zm-noti7-popup-footer"><a href="/notifications" class="zm-noti7-popup-footer-all zg-right">查看全部 &raquo;</a><a href="/settings/notification" class="zm-noti7-popup-footer-set" title="通知设置" ><i class="zg-icon zg-icon-settings"></i></a></div></div></div></div></div></div><div class="zu-global-notify" id="zh-global-message" style="display:none"><div class="zg-wrap"><div class="zu-global-nitify-inner"><a class="zu-global-notify-close" href="javascript:;" title="关闭" name="close">x</a><span class="zu-global-notify-icon"></span><span class="zu-global-notify-msg"></span></div></div></div><div class="zg-warn-message" id="zh-question-redirect-info" style="display:none"></div><div class="zg-wrap zu-main clearfix with-indention-votebar"  role="main"><div class="zu-main-content"><div class="zu-main-content-inner"><div class="zm-tag-editor zg-section"><div class="zm-tag-editor-labels zg-clear"><a class="zm-item-tag"href="/topic/19552686"data-tip="t$b$19552686" data-token="19552686" data-topicid="824">操作系统</a><a class="zm-item-tag"href="/topic/19552747"data-tip="t$b$19552747" data-token="19552747" data-topicid="847">英特尔 (Intel)</a><a class="zm-item-tag"href="/topic/19561633"data-tip="t$b$19561633" data-token="19561633" data-topicid="3807">C（编程语言）</a><a class="zm-item-tag"href="/topic/19717470"data-tip="t$b$19717470" data-token="19717470" data-topicid="55907">计算机体系架构 (Computer Architecture)</a><a class="zm-item-tag"href="/topic/19823428"data-tip="t$b$19823428" data-token="19823428" data-topicid="93219">CPU 指令集</a></div></div><div id="zh-question-title" data-editable="false"><h2 class="zm-item-title zm-editable-content"><a href="/question/31325454">请问，多个线程可以读一个变量，只有一个线程可以对这个变量进行写，到底要不要加锁？</a></h2></div><div id="zh-question-detail" class="zm-item-rich-text" data-resourceid="4727522" data-action="/question/detail"><div class="zm-editable-content">我自己的理解是，赋值操作对应两条汇编指令，所以需要加锁。不知道对不对</div></div><div class="zm-item-meta zm-item-comment-el clearfix" id="zh-question-meta-wrap"><div class="zm-meta-panel"><a href="#" name="addcomment" class="toggle-comment meta-item"><i class="z-icon-comment"></i>4 条评论</a><a href="#" name="share" class="share meta-item"><i class="z-icon-share"></i>分享</a></div><div class="panel-container"></div></div><div class="zh-question-answer-summary-wrap zm-item-rich-text" id="zh-question-answer-summary-wrap" style="display:none;"><h3><a href="http://www.zhihu.com/question/20014415" target="_blank" class="zg-right zg-link-litblue" style="font-weight:normal">什么是答案总结？</a>答案总结</h3><div id="zh-question-answer-summary" class="zg-section"data-resourceid="4727522" data-action="/question/summary"><div class="zm-editable-content"></div></div></div><div class="zh-answers-title"><h3><a href="/question/31325454" class="zg-link-litblue">查看全部 54 个回答</a></h3></div><div id="zh-question-answer-wrap" class="zh-question-answer-wrapper autohide-false"data-widget="navigable" data-navigable-options="{&quot;items&quot;:&quot;&gt;.zm-item-answer&quot;}"style="border-bottom:none;"><div tabindex="-1" class="zm-item-answer  zm-item-expanded"itemscope itemtype="http://schema.org/Answer"data-aid="16172324"data-atoken="51920170"data-collapsed="0"data-created="1434691097"data-deleted="0"data-helpful="1"data-isowner="0"data-copyable="1"><a class="zg-anchor-hidden" name="answer-16172324"></a><div class="zm-votebar"><button class="up "><i class="icon vote-arrow"></i><span class="count">103</span><span class="label sr-only">赞同</span></button><button class="down "><i class="icon vote-arrow"></i><span class="label sr-only">反对</span></button></div><div class="answer-head"><div class="zm-item-answer-author-info"><a class="zm-item-link-avatar avatar-link" href="/people/liu-ran-67-90" data-tip="p$t$liu-ran-67-90"><img src="https://pic1.zhimg.com/b53c5a354_s.jpg" class="zm-list-avatar avatar"></a><a class="author-link" data-tip="p$t$liu-ran-67-90" href="/people/liu-ran-67-90">刘然</a>，<span title="Kernel Hacker" class="bio">Kernel Hacker</span></div><div class="zm-item-vote-info " data-votecount="103"><span class="voters"><span class="user-block"><a data-tip="p$t$yang-jian-xin-51" href="http://www.zhihu.com/people/yang-jian-xin-51" class="zg-link" title="杨建新">杨建新</a>、</span><span class="user-block"><a data-tip="p$t$ijesonchen" href="http://www.zhihu.com/people/ijesonchen" class="zg-link" title="Jeson Chen">Jeson Chen</a>、</span><span class="user-block"><a data-tip="p$t$uaZ_" href="http://www.zhihu.com/people/uaZ_" class="zg-link" title="uazw">uazw</a></span></span><a href="javascript:;" class="more"> 等人赞同</a></div></div><div class="zm-item-rich-text js-collapse-body" data-resourceid="4727522" data-action="/answer/content" data-author-name="刘然" data-entry-url="/question/31325454/answer/51920170"><div class="zh-summary summary clearfix" style="display:none;">不是很同意 <a data-hash="b07cd4743bee223e37bad07299114cfc" href="//www.zhihu.com/people/b07cd4743bee223e37bad07299114cfc" class="member_mention" data-editable="true" data-title="@北极" data-tip="p$b$b07cd4743bee223e37bad07299114cfc">@北极</a> 的答案，这个要分情况进行讨论，其实大多数时候并不需要加锁。<b>第一种情况：</b>读线程不会干扰写线程，换句话说，写变量的线程下面的操作不依赖于读线程已经看到自己所写的值时：<b><u>不需要加锁</u>，多核体系好比分布式系统，只有事件发生的因果顺序…</b><a href="/question/31325454/answer/51920170" class="toggle-expand">显示全部</a></div><div class="zm-editable-content clearfix">不是很同意 <a data-hash="b07cd4743bee223e37bad07299114cfc" href="//www.zhihu.com/people/b07cd4743bee223e37bad07299114cfc" class="member_mention" data-editable="true" data-title="@北极" data-tip="p$b$b07cd4743bee223e37bad07299114cfc">@北极</a> 的答案，这个要分情况进行讨论，其实大多数时候并不需要加锁。<br><br><b>第一种情况：</b><br>读线程不会干扰写线程，换句话说，写变量的线程下面的操作不依赖于读线程已经看到自己所写的值时：<b><u>不需要加锁</u>，多核体系好比分布式系统，只有事件发生的因果顺序才是重要的，绝对时间并不重要</b><br><br><br><b>第二种情况：</b><br>逻辑上允许读线程读到旧的值，此时<b><u>不需要加锁</u></b>，这也是RCU的主要应用场景<br><br><b>第三种情况：</b><br>写线程写的数据处于同一条cache line内部，且可以原子的一条指令写完，此时<b><u>不需要加锁</u>，需要在读写两侧加上合适的Memory Barrier,在x86上是lock前缀指令和fence指令等</b><br><br><br><b>第四种情况：</b><br><b><u>请加读写锁。</u></b><br><br><b>----</b><br>当然，如果你对性能要求十分苛刻，一个周期也不想浪费，可以试一下我提出的被动读写锁<br><b>参见我的论文：</b><b>Scalable Read-mostly Synchronization UsingPassive Reader-Writer Locks</b><br><b><a href="https://www.usenix.org/system/files/conference/atc14/atc14-paper-liu.pdf" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">usenix.org/system/files</span><span class="invisible">/conference/atc14/atc14-paper-liu.pdf</span><span class="ellipsis"></span><i class="icon-external"></i></a></b></div></div><a class="zg-anchor-hidden ac" name="16172324-comment"></a><div class="zm-item-meta zm-item-comment-el answer-actions clearfix"><div class="zm-meta-panel"><span class="answer-date-link-wrap"><a class="answer-date-link meta-item" target="_blank" href="/question/31325454/answer/51920170">发布于 2015-06-19</a></span><a href="#" name="addcomment" class=" meta-item toggle-comment"><i class="z-icon-comment"></i>19 条评论</a><a href="#" class="meta-item zu-autohide" name="thanks" data-thanked="false"><i class="z-icon-thank"></i>感谢</a><a href="#" class="meta-item zu-autohide" name="share"><i class="z-icon-share"></i>分享</a><a href="#" class="meta-item zu-autohide" name="favo"><i class="z-icon-collect"></i>收藏</a><span class="zg-bull zu-autohide">&bull;</span><a href="#" name="nohelp" class="meta-item zu-autohide">没有帮助</a><span class="zg-bull zu-autohide">&bull;</span><a href="#" name="report" class="meta-item zu-autohide">举报</a><span class="zg-bull">&bull;</span><a href="/terms#sec-licence-1" target="_blank" class="meta-item copyright"> 作者保留权利 </a></div></div></div></div><div class="more-awesome"><span>更多回答</span></div><div class="awesome-answer-list"><div class="feed-item"><div class="content"><div class="entry-body "data-aid="16118643"data-atoken="51786285"data-collapsed="False"data-created="1434601037"data-deleted="0"data-isowner="0"data-helpful="1"data-score="0"data-copyable="1"><div class="zm-item-vote"><a class="zm-item-vote-count js-expand js-vote-count" href="javascript:;" data-votecount="154">154</a></div><div class="zm-votebar"><button class="up "><i class="icon vote-arrow"></i><span class="count">154</span><span class="label sr-only">赞同</span></button><button class="down "><i class="icon vote-arrow"></i><span class="label sr-only">反对</span></button></div><div class="zm-item-answer-detail"><div class="zm-item-answer-author-info"><a class="author-link" data-tip="p$t$bei-ji-85" href="/people/bei-ji-85">北极</a>，<span title="Simple Gifts" class="bio">Simple Gifts</span></div><div class="zm-item-vote-info " data-votecount="154"><span class="voters"><span class="user-block"><a data-tip="p$t$chou-rong-qi-shi-93" href="http://www.zhihu.com/people/chou-rong-qi-shi-93" class="zg-link" title="愁容骑士">愁容骑士</a>、</span><span class="user-block">知乎用户、</span><span class="user-block">知乎用户</span></span><a href="javascript:;" class="more"> 等人赞同</a></div><div class="zm-item-rich-text js-collapse-body" data-resourceid="4727522" data-action="/answer/content" data-author-name="北极" data-entry-url="/question/31325454/answer/51786285"><textarea class="content hidden">必须要。&lt;br&gt;&lt;br&gt;跟赋值是否是一条语句没有关系，甚至看上去汇编是原子的操作（比如MOV [内存]，寄存器这种）都不一定是真原子操作。&lt;br&gt;&lt;br&gt;如果是多线程+多核的情况，你的第一个线程在CPU0上修改了这个变量，第二个线程不会马上在CPU1上看到你的改动。&lt;br&gt;&lt;br&gt;因为你操作的变量都在缓存(cache)中，CPU0/1可能会同时保存一份变量缓存，也就是说你的变量在缓存里是两份，&lt;b&gt;只有一个CPU（核）更新的话是不一定触发另外一个CPU立即更新的&lt;/b&gt;。&lt;br&gt;&lt;br&gt;具体可以参考这个问题：&lt;a class=&quot;internal&quot; href=&quot;http://www.zhihu.com/question/26848513&quot;&gt;一个简单的ia32的CPU指令重排序与cache问题，我的推算为什么得不出示例的结果？ - CPU 指令集&lt;/a&gt;&lt;br&gt;&lt;br&gt;引用问题里的图：&lt;br&gt;&lt;br&gt;&lt;img src=&quot;https://pic1.zhimg.com/028044df862446772ed16576e2a2c444_b.jpg&quot; class=&quot;content_image&quot;&gt;&lt;br&gt;Java中最新的volatile是可以用的，C里的是不行的。Java中volatile会在x86平台上插入一个lock前缀（汇编指令）保证缓存一致性。&lt;br&gt;&lt;br&gt;MESI协议能保证cache的一致性，但MESI无法保证以下的情况：&lt;br&gt;&lt;br&gt;1、流水线上的load buffer；&lt;br&gt;2、跨cache行访问；&lt;br&gt;&lt;br&gt;所以说，在不确定访问数据是什么样的情况下，最可靠的办法是都加锁。</textarea><div class="zh-summary summary clearfix"><img src="https://pic1.zhimg.com/028044df862446772ed16576e2a2c444_xld.jpg" class="content_image inline-img">必须要。跟赋值是否是一条语句没有关系，甚至看上去汇编是原子的操作（比如MOV [内存]，寄存器这种）都不一定是真原子操作。如果是多线程+多核的情况，你的第一个线程在CPU0上修改了这个变量，第二个线程不会马上在CPU1上看到你的改动。因为你操作的变量都…<a href="/question/31325454/answer/51786285" class="toggle-expand">显示全部</a></div></div></div></div></div><a class="zg-anchor-hidden ac" name="16118643-comment"></a><div class="zm-item-meta zm-item-comment-el answer-actions clearfix"><div class="zm-meta-panel"><span class="answer-date-link-wrap"><a class="answer-date-link last_updated meta-item" data-tip="s$t$发布于 2015-06-18" target="_blank" href="/question/31325454/answer/51786285">编辑于 2015-06-22</a></span><a href="#" name="addcomment" class=" meta-item toggle-comment"><i class="z-icon-comment"></i>30 条评论</a><a href="#" class="meta-item zu-autohide" name="thanks" data-thanked="false"><i class="z-icon-thank"></i>感谢</a><a href="#" class="meta-item zu-autohide" name="share"><i class="z-icon-share"></i>分享</a><a href="#" class="meta-item zu-autohide" name="favo"><i class="z-icon-collect"></i>收藏</a><span class="zg-bull zu-autohide">&bull;</span><a href="#" name="nohelp" class="meta-item zu-autohide">没有帮助</a><span class="zg-bull zu-autohide">&bull;</span><a href="#" name="report" class="meta-item zu-autohide">举报</a><span class="zg-bull">&bull;</span><a href="/terms#sec-licence-1" target="_blank" class="meta-item copyright"> 作者保留权利 </a></div></div></div><div class="feed-item"><div class="content"><div class="entry-body "data-aid="23240186"data-atoken="69550316"data-collapsed="False"data-created="1445913291"data-deleted="0"data-isowner="0"data-helpful="1"data-score="0"data-copyable="1"><div class="zm-item-vote"><a class="zm-item-vote-count js-expand js-vote-count" href="javascript:;" data-votecount="80">80</a></div><div class="zm-votebar"><button class="up "><i class="icon vote-arrow"></i><span class="count">80</span><span class="label sr-only">赞同</span></button><button class="down "><i class="icon vote-arrow"></i><span class="label sr-only">反对</span></button></div><div class="zm-item-answer-detail"><div class="zm-item-answer-author-info"><a class="author-link" data-tip="p$t$giantchen" href="/people/giantchen">陈硕</a>，<span title="Linux C++程序员，muduo 网络库作者" class="bio">Linux C++程序员，muduo 网络库作者</span></div><div class="zm-item-vote-info " data-votecount="80"><span class="voters"><span class="user-block">知乎用户、</span><span class="user-block"><a data-tip="p$t$he-scott" href="http://www.zhihu.com/people/he-scott" class="zg-link" title="he scott">he scott</a>、</span><span class="user-block"><a data-tip="p$t$yayj" href="http://www.zhihu.com/people/yayj" class="zg-link" title="zihuatanejo">zihuatanejo</a></span></span><a href="javascript:;" class="more"> 等人赞同</a></div><div class="zm-item-rich-text js-collapse-body" data-resourceid="4727522" data-action="/answer/content" data-author-name="陈硕" data-entry-url="/question/31325454/answer/69550316"><textarea class="content hidden">我不负责任地总结一句：凡是在网上问要不要加锁的，答案一律是&lt;b&gt;要加锁&lt;/b&gt;，没有例外。&lt;br&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://software.intel.com/en-us/blogs/2013/01/06/benign-data-races-what-could-possibly-go-wrong&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Benign data races: what could possibly go wrong?&lt;i class=&quot;icon-external&quot;&gt;&lt;/i&gt;&lt;/a&gt;&lt;br&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://www.usenix.org/conference/osdi10/ad-hoc-synchronization-considered-harmful&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Ad Hoc Synchronization Considered Harmful&lt;i class=&quot;icon-external&quot;&gt;&lt;/i&gt;&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;为了避免扯皮（原子操作算不算加锁？），第一句话的“&lt;b&gt;加锁&lt;/b&gt;”应该理解为“同步/synchronization”。其实我认为 atomic operations are dangerous，或者用 Herb Sutter 的话来说，是 &lt;a href=&quot;https://isocpp.org/blog/2015/05/cppcon-2014-lock-free-programming-or-juggling-razor-blades-part-i-herb-sutt&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Juggling Razor Blades&lt;i class=&quot;icon-external&quot;&gt;&lt;/i&gt;&lt;/a&gt;，一般程序员老老实实用 mutex 就好了。&lt;br&gt;我知道会有很多人不同意我的观点，而且会有各路专家站出来证明某种情况下不加锁也是可行的，不必费力说服我，你们开心就好了。</textarea><div class="zh-summary summary clearfix">我不负责任地总结一句：凡是在网上问要不要加锁的，答案一律是<b>要加锁</b>，没有例外。<a href="https://software.intel.com/en-us/blogs/2013/01/06/benign-data-races-what-could-possibly-go-wrong" class=" wrap external" target="_blank" rel="nofollow noreferrer">Benign data races: what could possibly go wrong?<i class="icon-external"></i></a><a href="https://www.usenix.org/conference/osdi10/ad-hoc-synchronization-considered-harmful" class=" wrap external" target="_blank" rel="nofollow noreferrer">Ad Hoc Synchronization Considered Harmful<i class="icon-external"></i></a>为了避免扯皮（原子操作算不算加锁？），第一句话的“<b>加锁</b>”应该理解为“同步/…<a href="/question/31325454/answer/69550316" class="toggle-expand">显示全部</a></div></div></div></div></div><a class="zg-anchor-hidden ac" name="23240186-comment"></a><div class="zm-item-meta zm-item-comment-el answer-actions clearfix"><div class="zm-meta-panel"><span class="answer-date-link-wrap"><a class="answer-date-link last_updated meta-item" data-tip="s$t$发布于 2015-10-27" target="_blank" href="/question/31325454/answer/69550316">编辑于 2015-10-27</a></span><a href="#" name="addcomment" class=" meta-item toggle-comment"><i class="z-icon-comment"></i>4 条评论</a><a href="#" class="meta-item zu-autohide" name="thanks" data-thanked="false"><i class="z-icon-thank"></i>感谢</a><a href="#" class="meta-item zu-autohide" name="share"><i class="z-icon-share"></i>分享</a><a href="#" class="meta-item zu-autohide" name="favo"><i class="z-icon-collect"></i>收藏</a><span class="zg-bull zu-autohide">&bull;</span><a href="#" name="nohelp" class="meta-item zu-autohide">没有帮助</a><span class="zg-bull zu-autohide">&bull;</span><a href="#" name="report" class="meta-item zu-autohide">举报</a><span class="zg-bull">&bull;</span><a href="/terms#sec-licence-1" target="_blank" class="meta-item copyright"> 作者保留权利 </a></div></div></div></div><div class="zh-answers-title"><h3><a href="/question/31325454" class="zg-link-litblue">查看全部 54 个回答</a></h3></div><div class="zu-answer-form-disabled-wrap" id="zh-single-answer-disable-wrap" style="display:none"></div><div class="shameimaru-placeholder" data-class="AnswerBottomShameimaruV2" data-params='{&quot;token&quot;:31325454}'></div></div></div><div class="zu-main-sidebar"><div class="zm-side-section"><div class="zm-side-section-inner"><div class="well login-reg-box"><span>知乎是一个真实的问答社区，在这里分享知识、经验和见解，发现更大的世界。<br><a id="js-reg-with-mail-in-top" href="#">使用手机或邮箱注册</a><!-- <span>·</span><a id="js-reg-with-qq-in-top" href="#">使用 QQ 登录</a> --></span><div class="clearfix"><a id="js-reg-with-wechat-in-top" href="#" class="zg-btn-green"><span class="z-ico-wechat-right-panel"></span>使用微信登录</a><a id="js-reg-with-sina-in-top" href="#" class="zg-btn-red"><span class="icon-big-white-sina"></span>使用微博登录</a><a id="js-reg-with-qq-in-top" href="#" class="zg-btn-blue"><span class="icon-big-white-qq"></span>使用 QQ 登录</a></div></div></div></div><div class="zm-side-section"><div class="zm-side-section-inner zg-gray-normal" id="zh-question-side-header-wrap"><button data-follow="q:m:button" class="follow-button zg-follow zg-btn-green" data-id="4727522">关注问题</button>717人关注该问题</div></div><div class="zm-side-section sidebar-author-info clearfix"><div class="zm-side-section-inner" id="js-sidebar-author-info"><h3>关于作者</h3><div class="zm-profile-card zm-profile-section-item zg-clear no-hovercard"><div class="zg-right"><button data-follow="m:button" data-id="04fbfba44a869601cfcefa3013c8fcfa" class="zg-btn zg-btn-follow zm-rich-follow-btn small nth-0">关注他</button></div><a title="刘然"data-tip="p$t$liu-ran-67-90"class="zm-item-link-avatar"href="/people/liu-ran-67-90"><img src="https://pic1.zhimg.com/b53c5a354_m.jpg" class="zm-item-img-avatar"></a><div class="zm-list-content-medium"><h2 class="zm-list-content-title"><a data-tip="p$t$liu-ran-67-90" href="http://www.zhihu.com/people/liu-ran-67-90" class="zg-link" title="刘然">刘然</a></h2><div class="zg-big-gray">知我者谓我心忧</div><div class="details zg-gray"><a target="_blank" href="/people/liu-ran-67-90/followers" class="zg-link-gray-normal">6627 关注者</a>/<a target="_blank" href="/people/liu-ran-67-90/asks" class="zg-link-gray-normal">6 提问</a>/<a target="_blank" href="/people/liu-ran-67-90/answers" class="zg-link-gray-normal">84 回答</a>/<a target="_blank" href="/people/liu-ran-67-90" class="zg-link-gray-normal">13034 赞同</a></div></div></div></div></div><div class="shameimaru-placeholder" data-class="AnswerUpShameimaruV2" data-params='{&quot;token&quot;:31325454}'></div><div class="zm-side-section"><div class="zm-side-section-inner"><h3>被收藏 <a href="/question/31325454/answer/51920170/collections">26</a> 次</h3><div id="zh-fav-list-side-related"><div class="zm-item" id="mi-1405475189"><h2 class="zm-item-title "><a href="/collection/38296052">技术</a></h2><div class="zm-item-meta"><a href="/people/he-meng-95" data-tip="p$t$he-meng-95" class="zg-link-litblue"> 和萌 </a> 创建<span style="color: #dddddd;">&nbsp;|&nbsp;</span><a class="zg-link-gray" href="/collection/38296052/followers">1 人关注</a></div></div><div class="zm-item" id="mi-1392708899"><h2 class="zm-item-title "><a href="/collection/31544759">好</a></h2><div class="zm-item-meta"><a href="/people/huang-xiao-yu-98" data-tip="p$t$huang-xiao-yu-98" class="zg-link-litblue"> 黄晓宇 </a> 创建<span style="color: #dddddd;">&nbsp;|&nbsp;</span><a class="zg-link-gray" href="/collection/31544759/followers">1 人关注</a></div></div><div class="zm-item" id="mi-1415363988"><h2 class="zm-item-title "><a href="/collection/41004206">编程</a></h2><div class="zm-item-meta"><a href="/people/huang-jin-hua-67" data-tip="p$t$huang-jin-hua-67" class="zg-link-litblue"> 黄锦华 </a> 创建<span style="color: #dddddd;">&nbsp;|&nbsp;</span><a class="zg-link-gray" href="/collection/41004206/followers">1 人关注</a></div></div><div class="zm-item" id="mi-1413434388"><h2 class="zm-item-title "><a href="/collection/40410345">michael_yu</a></h2><div class="zm-item-meta"><a href="/people/michael-yu-47" data-tip="p$t$michael-yu-47" class="zg-link-litblue"> Michael Yu </a> 创建<span style="color: #dddddd;">&nbsp;|&nbsp;</span><a class="zg-link-gray" href="/collection/40410345/followers">0 人关注</a></div></div><div class="zm-item" id="mi-1420649019"><h2 class="zm-item-title "><a href="/collection/43100820">xue</a></h2><div class="zm-item-meta"><a href="/people/eli-smith" data-tip="p$t$eli-smith" class="zg-link-litblue"> Eli Smith </a> 创建<span style="color: #dddddd;">&nbsp;|&nbsp;</span><a class="zg-link-gray" href="/collection/43100820/followers">0 人关注</a></div></div></div></div></div><div class="zm-side-section"><div class="zm-side-section-inner"><div id="zh-question-related-questions" class="zh-question-related-questions clearfix"><a class="zg-right next">换一换</a><h3>相关问题</h3><ul itemprop="relatedQuestion" itemscope itemtype="http://schema.org/ItemList"><li itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/23667562">现在哪些编程语言适合写操作系统？</a> <span class="num">11 个回答</span><meta itemprop="followerCount" content="97" /></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/21302126">如何Linux入门？</a> <span class="num">13 个回答</span><meta itemprop="followerCount" content="188" /></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/23207447">Nokia X 可以安装 Xposed 框架吗？</a> <span class="num">2 个回答</span><meta itemprop="followerCount" content="8" /></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/22619217">如何高效的使用Gmail？</a> <span class="num">11 个回答</span><meta itemprop="followerCount" content="58" /></li><li itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/25268303">Linux 和 Windows 下有很多通用编程语言，有类似 Qt 的 UI 框架，为什么多数企业的仍缺少 Linux 客户端呢？</a> <span class="num">18 个回答</span><meta itemprop="followerCount" content="97" /></li><li hidden itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/20365910">有哪些自带运行环境的编程语言？</a> <span class="num">3 个回答</span><meta itemprop="followerCount" content="10" /></li><li hidden itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/20940549">有那些app能提高效率？</a> <span class="num">6 个回答</span><meta itemprop="followerCount" content="14" /></li><li hidden itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/21374970">如何入门windows内核开发的大门？</a> <span class="num">3 个回答</span><meta itemprop="followerCount" content="11" /></li><li hidden itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/22601175">Linux如何高效安装程序？</a> <span class="num">4 个回答</span><meta itemprop="followerCount" content="10" /></li><li hidden itemprop="itemListElement" itemscope itemtype="http://schema.org/Question"><a class="question_link" href="/question/19995926">做接口最好的编程语言？</a> <span class="num">3 个回答</span><meta itemprop="followerCount" content="11" /></li></ul></div></div></div><div class="zm-side-section zh-answer-status"><div class="zm-side-section-inner"><h3>回答状态</h3><p>发布于<span class="time">2015-06-19</span></p><p>所属问题被浏览 <strong>28530</strong> 次</p><p class="copyright"><a href="/terms#sec-licence"><i class="icon icon-copyable"></i>作者保留所有权利</a></p></div></div><div class="shameimaru-placeholder" data-class="AnswerDownShameimaruV2" data-params='{&quot;token&quot;:31325454}'></div></div></div><div id="zh-footer" class="zh-footer"><div class="content zg-wrap clearfix"><ul><li><a href="https://liukanshan.zhihu.com" target="_blank">刘看山</a></li><li><a href="/app" target="_blank">移动应用</a></li><li><a href="/careers">加入知乎</a></li><li><a href="/terms" target="_blank">知乎协议</a></li><li><a href="mailto:bd@zhihu.com">商务合作</a></li></ul><span class="copy">&copy; 2015 知乎</span></div></div><script type="text/json" class="json-inline" data-name="guiders2">{}</script><script type="text/json" class="json-inline" data-name="current_user">["","","","-1","",0,0]</script><script type="text/json" class="json-inline" data-name="env">["zhihu.com","comet.zhihu.com",false,null]</script><script type="text/json" class="json-inline" data-name="permissions">[]</script><script type="text/json" class="json-inline" data-name="ga_vars">{"user_created":0,"now":1449138725000,"abtest_mask":"------------------------------","user_attr":[0,0,0,"-","-"],"user_hash":0}</script><script type="text/json" class="json-inline" data-name="current_question">{"status":"normal","isLocked":0,"detailEditReasonRequired":true,"editPermission":false,"isAnon":0,"qid":4727522,"urlToken":31325454,"askAboutMember":0}</script><script type="text/json" class="json-inline" data-name="draft">[]</script><script src="http://static.zhihu.com/static/revved/-/js/vendor.1a51eb6e.js"></script><script src="http://static.zhihu.com/static/revved/-/js/closure/common.d3bfcd50.js"></script><script src="http://static.zhihu.com/static/revved/-/js/closure/richtexteditor.4bc37c3f.js" async></script><script src="http://static.zhihu.com/static/revved/-/js/closure/page-main.7d067a7b.js"></script><meta name="entry" content="ZH.entrySA" data-module-id="page-main"><script type="text/zscript" znonce="cc68582f20444b2c82320554eabb847e"></script><input type="hidden" name="_xsrf" value="eb19c276f1d57515f90b35eea12b6df6"/></body></html>